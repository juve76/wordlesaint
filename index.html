// This file is designed to be deployed as a serverless function, 
// for example, on Vercel under the /api directory.

// IMPORTANT: Replace 'YOUR_GEMINI_API_KEY_HERE' with your actual API key
// OR, better yet, set it as an environment variable named GEMINI_API_KEY 
// in your Vercel project settings and use process.env.GEMINI_API_KEY.

const GEMINI_API_KEY = process.env.GEMINI_API_KEY || 'YOUR_GEMINI_API_KEY_HERE';
const FLASH_MODEL = "gemini-2.5-flash-preview-09-2025";
const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${FLASH_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

/**
 * Handles incoming requests to forward them to the Gemini API.
 * @param {import('http').IncomingMessage} req 
 * @param {import('http').ServerResponse} res 
 */
export default async function handler(req, res) {
    // Only allow POST requests, as required by the Gemini API
    if (req.method !== 'POST') {
        res.setHeader('Allow', ['POST']);
        return res.status(405).end(`Method ${req.method} Not Allowed`);
    }

    // Set CORS headers to allow your GitHub Pages site to access this proxy
    res.setHeader('Access-Control-Allow-Origin', '*'); // Allow all origins for simplicity, but you could restrict this to your github.io URL
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    // Handle preflight requests (OPTIONS)
    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    try {
        // Read the request body from the client (your game)
        const requestBody = await getRequestBody(req);

        // Forward the request to the official Gemini API endpoint
        const apiResponse = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        // Check for non-200 status codes from the Gemini API
        if (!apiResponse.ok) {
            const errorText = await apiResponse.text();
            console.error('Gemini API Error:', apiResponse.status, errorText);
            return res.status(apiResponse.status).json({ 
                error: 'Error from Gemini API', 
                status: apiResponse.status, 
                details: errorText 
            });
        }

        // Send the response from Gemini back to the client
        const data = await apiResponse.json();
        res.status(200).json(data);

    } catch (error) {
        console.error('Proxy Server Error:', error);
        res.status(500).json({ error: 'Internal Server Error during proxy operation' });
    }
}

/**
 * Helper function to parse the incoming request body.
 */
function getRequestBody(req) {
    return new Promise((resolve, reject) => {
        let body = '';
        req.on('data', chunk => {
            body += chunk.toString();
        });
        req.on('end', () => {
            try {
                resolve(JSON.parse(body));
            } catch (err) {
                reject(new Error("Invalid JSON body"));
            }
        });
        req.on('error', reject);
    });
}
